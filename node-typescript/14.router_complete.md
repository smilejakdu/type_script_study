ë‹¨ìˆ˜ë³µìˆ˜ëŠ” ì™œ êµ¬ë³„ì„ í•˜ëŠ”ê±¸ê¹Œ??


ë³´í†µ rest api ì—ì„œëŠ” ë‹¨ìˆ˜ë§Œ ì‚¬ìš©ì„ í•œë‹¤ .


í•˜ì§€ë§Œ ì œë¡œì´ˆë‹˜ì€ ì™œ ë‹¨ìˆ˜ ë³µìˆ˜ ë‘˜ë‹¤ ì‚¬ìš©ì„ í•˜ëŠ”ê²ƒì¼ê¹Œ?


ì›ë˜ë¼ë©´ ê·¸ë ‡ê²Œ ë§ì¶°ì„œ í•˜ëŠ”ê²Œ ë§ê¸´í•˜ë‹¤.


ë°ì´í„° í•˜ë‚˜ë§Œ ê°€ì§€ê³  ì˜¬ë•ŒëŠ” ë‹¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³ 


ë°ì´í„° ì—¬ëŸ¬ê°œë¥¼ ê°€ì§€ê³ ì˜¤ëŠ” router ì¼ ê²½ìš° ë³µìˆ˜ë¥¼ ì‚¬ìš©í•œë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/83d0599e-d8e3-443a-a4dd-a8e73532b4fc.png)


ê²Œì‹œê¸€ê³¼ ê²Œì‹œê¸€ì— ë”¸ë ¤ ìˆëŠ” hashtag ë“¤ì´ ìˆê² ì£ 


ê·¸ë¦¬ê³  ê²Œì‹œê¸€ ì‘ì„±ìë„ ìˆê² ì£ 

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/933aeb38-8868-4da6-87a6-46de1f49134c.png)


ê·¸ë¦¬ê³  ì‚¬ìš©ìë¥¼ ê°€ì ¸ì˜¬ë• ë¹„ë°€ë²ˆí˜¸ëŠ” ì•ˆë“¤ê³ ì˜¬ìˆ˜ìˆë„ë¡ attributes ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤. ( exclude ë¥¼ ì‚¬ìš©í•´ë„ ëœë‹¤. )


ê²Œì‹œê¸€ì— ì´ë¯¸ì§€ë„ ìˆì„ìˆ˜ë„ ìˆìœ¼ë‹ˆê¹ ì´ë¯¸ì§€ë„ ì‘ì„±ì„ í•´ì¤€ë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/d1fb1e5c-7a75-4757-9b26-f9d427e31089.png)


ê·¸ë¦¬ê³  ì¢‹ì•„ìš” ìˆ˜ë„ í•„ìš”í•˜ê¸°ë•Œë¬¸ì—

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/4034340b-16ef-40cf-9a2b-9b1d85d34341.png)

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/ff499ddb-8442-4613-af23-fad51d478f78.png)


ë§ˆì§€ë§‰ìœ¼ë¡œ ì •ë ¬ë°©ë²•ì„ ë„£ì–´ì¤€ë‹¤.

```ts
import express from 'express';
import Sequelize from 'sequelize';

import Hashtag from '../models/hashtag';
import Image from '../models/image';
import Post from '../models/post';
import User from '../models/user';

const router = express.Router();

router.get<any, any, any, { lastId: string, limit: string }>('/:tag', async (req, res, next) => {
  try {
    let where = {};
    if (parseInt(req.query.lastId, 10)) {
      where = {
        id: {
          [Sequelize.Op.lt]: parseInt(req.query.lastId, 10),
        },
      };
    }
    const posts = await Post.findAll({
      where,
      include: [{
        model: Hashtag,
        where: { name: decodeURIComponent(req.params.tag) },
      }, {
        model: User,
        attributes: ['id', 'nickname'],
      }, {
        model: Image,
      }, {
        model: User,
        as: 'Likers',
        attributes: ['id'],
      }, {
        model: Post,
        as: 'Retweet',
        include: [{
          model: User,
          attributes: ['id', 'nickname'],
        }, {
          model: Image,
        }]
      }],
      order: [['createdAt', 'DESC']],
      limit: parseInt(req.query.limit, 10),
    })
  } catch (err) {
    console.error(err);
    return next(err);
  }
});

export default router;

```

# ğŸ“Œ routes/posts.ts

```ts
import express from 'express';
import Sequelize from 'sequelize';
import Image from '../models/image';
import Post from '../models/post';
import User from '../models/user';

const router = express.Router();

router.get<any, any, any, { lastId: string, limit: string }>('/', async (req, res, next) => {
  try {
    let where = {};
    if (parseInt(req.query.lastId, 10)) {
      where = {
        id: {
          [Sequelize.Op.lt]: parseInt(req.query.lastId, 10), // less than
        },
      };
    }
    const posts = await Post.findAll({
      where,
      include: [{
        model: User,
        attributes: ['id', 'nickname'],
      }, {
        model: Image,
      }, {
        model: User,
        as: 'Likers',
        attributes: ['id'],
      }, {
        model: Post,
        as: 'Retweet',
        include: [{
          model: User,
          attributes: ['id', 'nickname'],
        }, {
          model: Image,
        }],
      }],
      order: [['createdAt', 'DESC']], // DESCëŠ” ë‚´ë¦¼ì°¨ìˆœ, ASCëŠ” ì˜¤ë¦„ì°¨ìˆœ
      limit: parseInt(req.query.limit, 10),
    });
    return res.json(posts);
  } catch (err) {
    console.error(err);
    return next(err);
  }
});

export default router;

```

# ğŸ“Œ routes/post.ts


ì ê¹ ë³µìŠµì„ í•˜ìë©´ ì§€ë‚œì‹œê°„ì— promises ë¥¼ ì‚¬ìš©í•˜ëŠ”ë° , promises ì˜ ì¡°ê¸ˆ í™•ì¥íŒì¸ BlueBird ë¥¼ ì‚¬ìš©í•œë‹¤.


ì›ë˜ ê¸°ë³¸ì ìœ¼ë¡œ

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/0075d178-d040-4855-b65b-dbae2bca1915.png)


ì´ë ‡ê²Œ ë°”ë¡œ Promise ë¥¼ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ sequelize ì—ì„œëŠ” BlueBird ë¥¼ ì‚¬ìš©í•œë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/e30bdc59-1d61-42e0-b7b0-dab525d527db.png)


# ğŸ“Œ routes/images

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/a46993ef-94c3-4641-9e3c-659b2e56b826.png)


ì‘ì„±ì„ í•˜ë‹¤ê°€ ì´ë ‡ê²Œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ í•­ìƒ ì—ëŸ¬ë¥¼ í™•ì¸í•œë‹¤.


map ì´ë¼ëŠ”ê²ƒì´ ë°°ì—´ì˜ ë©”ì„œë“œì¸ë° ,

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/32ee9d2a-2212-4948-bac5-13bcce7fcb6c.png)


ì•ˆì— ë“¤ì–´ê°€ê²Œ ë˜ë©´ ì´ë ‡ê²Œ ë˜ì–´ìˆë‹¤.


ì´ë ‡ê²Œ ê°ì²´ì¼ ê²½ìš°ì— map ì„ ì‚¬ìš©í• ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— , ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/537a0483-d4ab-41e8-b4a1-a065f9b09132.png)


ê·¸ë˜ì„œ ì´ë ‡ê²Œ ë°”ê¿”ì£¼ê²Œ ë˜ë©´ ì—ëŸ¬ê°€ ì‚¬ë¼ì§€ê²Œ ëœë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/8f9070f7-d0ae-4449-8022-532d218e31dd.png)


ì—¬ê¸°ì„œ location ì´ ë­ì§€ ?? í™•ì¸ì„ í• ë ¤ê³  ì•ˆì— ë“¤ì–´ê°€ë³´ë©´


multer ìì²´ì—ì„œëŠ” ë‚˜ì˜¤ì§€ ì•Šì•˜ë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/b6e57848-5234-4107-874f-dbbbe2864cac.png)


ì—¬ê¸°ì„œëŠ” ì•ˆë³´ì´ê³  multerS3 ê°€ í™•ì¥ì„ í•œê²ƒì´ë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/5412d1ff-e07f-4a53-af0d-c15b4d4d7990.png)


ì—¬ê¸°ì— location ì´ ë“¤ì–´ìˆë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/1ffc4b69-db46-4168-904f-b17eb711ad1b.png)


ì—¬ê¸°ì„œ ê·¸ë˜ì„œ Express.MulterS3.File ì„ ì‚¬ìš©í•´ì„œ íƒ€ì…ì„ ì§€ì •í• ë ¤ê³  í•˜ëŠ”ë° ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.


req.files ê¹Œì§€ëŠ” ê·¸ëƒ¥ Multer ì˜€ëŠ”ë° ê°‘ìê¸° map ì„ ì‚¬ìš©í• ë• Express.MulterS3.File ì„ ì‚¬ìš©í• ë ¤ê³  í•˜ë‹ˆê¹ ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.


ê·¸ë˜ì„œ ìœ„ì—ì„œë¶€í„° ë°”ê¿”ì¤˜ì•¼í•œë‹¤.

![14.ë¼ìš°í„° ì™„ì„±í•˜ê¸° image](https://slid-capture.s3.ap-northeast-2.amazonaws.com/public/capture_images/a84aa7f38e8a496e98edd55f0174acba/90371d05-a2c8-4e22-9425-da415ab5c4dc.png)


## Post í•˜ë‚˜ ê°€ì ¸ì˜¤ê¸°

```ts
router.get('/:id', async (req, res, next) => {
  try {
    const post = await Post.findOne({
      where: { id: req.params.id },
      include: [{
        model: User,
        attributes: ['id', 'nickname'],
      }, {
        model: Image,
      }, {
        model: User,
        as: 'Likers',
        attributes: ['id'],
      }],
    });
    return res.json(post);
  } catch (e) {
    console.error(e);
    return next(e);
  }
});
```



